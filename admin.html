<!DOCTYPE html>
<html>
<head>
    <title>Admin panel</title>
</head>
<body>
<form>
    <fieldset>
        <legend>Sort by:</legend>
        <div>
            <input type="radio" id="popularity" name="sort" checked />
            <label for="popularity">Popularity</label>
        </div>

        <div>
            <input type="radio" id="dateAdded" name="sort" />
            <label for="dateAdded">Date Created</label>
        </div>
    </fieldset>
</form>
<h1>TODO: sort the actual elements once we have an API</h1>
<h1>TODO: get all the details, once the api is in place, including surveys</h1>
<div>
    <input id="search" />
    <button onlick="searchFor();">Search</button>
</div>
<div id="content"></div>

<!-- TODO - these api calls use the feed api.
    When backend adds an admin api, we can swap that out.
-->
<script>

  var exhibits = [];
  var request = new XMLHttpRequest();


  function getAllExhibits(completionHandler) {
    var startIdx = 0;
    var total;

    request.onreadystatechange = function() {
      if (this.readyState === 4 && this.status === 200) {
        let json = JSON.parse(this.responseText);
        total = json.count;
        startIdx += json.pageSize;

        for (let i = 0; i < json.exhibits.length; i++) {
          exhibits.push(json.exhibits[i]);
        }

        if (startIdx < total) {
          request.open('GET', 'http://localhost:8080/feed/new?startIdx=' + startIdx, true);
          request.send();
        } else {
          completionHandler();
        }
      }
    };

    // start the first one
    request.open('GET', 'http://localhost:8080/feed/new?startIdx=0', true);
    request.send();
  }

  var draw = function() {
    let div = document.getElementById("content");
    div.innerHTML = "";
    for (let i = 0; i < exhibits.length; i++) {
      let ex = document.createElement("div");
      ex.style = "border: 1px solid black;";
      ex.innerHTML += `<p>Title: ${exhibits[i].title}</p>`;
      ex.innerHTML += '<p>Date created: Today (backend needs to add this to the admin api)</p>';
      ex.innerHTML += `<p>Supporters: ${exhibits[i].supporterCount}</p>`;
      ex.innerHTML += '<p>Number of comments: (backend needs to add this to the admin api)</p>';
      ex.innerHTML += `<button onclick='deleteExhibit(${exhibits[i].id});'>Click to delete</button>`;
      div.appendChild(ex);
    }
  };

  function deleteExhibit(id) {
    // TODO add user confirmation

    let deleteReq = new XMLHttpRequest();
    deleteReq.onreadystatechange = function() {
      if (this.readyState === 4) {
        if (!this.status === 204) {
          alert("deleting exhibit failed. Please try again later");
        } else {
          // success remove from the list
          for (let i = 0; i < exhibits.length; i++) {
            if (exhibits[i].id === id) {
              exhibits.splice(i, 1);
            }
          }
          draw();
        }
      }
    };
    deleteReq.open('DELETE', `http://localhost:8080/exhibit/${id}`, true);
    deleteReq.send();
  }

  getAllExhibits(draw);

  function searchFor() {
      const item = document.getElementById("search").value;
      alert("Should search for: " + item + " once backend API in place.");
  }
</script>
</body>
</html>
